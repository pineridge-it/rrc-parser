# Database Integration Tests

This directory contains comprehensive database integration tests for the RRC Permit Scraper application, with a focus on testing Row Level Security (RLS) policies and multi-tenant data isolation.

## Test Structure

The tests are organized into several categories:

1. `rls-workspace.test.ts` - Workspace isolation tests
2. `rls-roles.test.ts` - Role-based access control tests
3. `rls-edge-cases.test.ts` - Edge case tests for RLS policies
4. `rls-security.test.ts` - Security prevention tests

## Key Test Categories

### Workspace Isolation
- Basic workspace isolation (users can only see data from their workspace)
- Cross-workspace update prevention
- Cross-workspace delete prevention
- Multi-workspace user access
- Deleted workspace handling
- User removal from workspace

### Role-Based Access Control
- Admin role access (full access within workspace)
- Member role access (read-write access)
- Viewer role access (read-only access)
- Superadmin access (access to all workspaces)

### Edge Cases
- Null workspace_id handling
- Null user_id handling
- Soft deleted workspace handling
- Soft deleted user handling
- Workspace transfer scenarios
- Empty workspace handling
- Maximum limits testing

### Security Prevention
- SQL injection prevention
- Direct table access prevention
- View security enforcement
- Function security enforcement
- Security policy verification

## Test Data

Tests use realistic test data generated by the factory classes in `tests/factories/`:

- `WorkspaceFactory` - Generates workspace data with realistic defaults
- `UserFactory` - Generates user data with different roles
- `PermitFactory` - Generates permit data for testing

## RLS Helper Utility

The `RLSHelper` class in `tests/helpers/rls-helper.ts` provides utilities for:

- Creating test clients for specific user and workspace contexts
- Generating test data with workspaces and users
- Creating superadmin users
- Creating users with different roles

## Test Philosophy

Following the real database testing principle, all tests use:

- Real PostgreSQL database (via testcontainers or local instance)
- Real Supabase client (connected to test project)
- Real SQL queries (not mocked query builders)
- Real transactions (BEGIN, COMMIT, ROLLBACK)
- Real RLS policies (enforced by PostgreSQL)

We do NOT use:

- In-memory SQLite (different behavior from PostgreSQL)
- Mocked database clients
- Stubbed query results
- Bypassed RLS policies

## Test Isolation Strategy

Each test gets a clean database state:

- Tests run in transactions that roll back after test
- Or tests run against isolated schemas
- Or tests use template databases

This ensures:

- Tests don't interfere with each other
- Tests can run in parallel
- No manual cleanup needed

## Dependencies

These tests require:

- Running PostgreSQL database instance
- Properly configured RLS policies in the database
- Test data factories from `tests/factories/`
- RLS helper utilities from `tests/helpers/`

## Performance Considerations

Database tests are slower than unit tests due to:

- Database connection overhead
- Transaction management
- Real data operations
- RLS policy evaluation

Tests should be categorized appropriately to optimize CI/CD pipeline performance.